apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: nginx-well-known
  namespace: social
spec:
  interval: 15m
  chart:
    spec:
      chart: nginx
      version: 17.1.0
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false


#  postRenderers:
#    - kustomize:
#        patches:
#          - target:
#              version: v1
#              kind: Deployment
#              name: nginx-well-known
#            patch: |-
#              - op: remove
#                path: /spec/values/service/ports/https 


  values:
    serverBlock: |-
      server {
        listen 0.0.0.0:8080;
        location / {
          return 200 "hello!";
        }
      }
    
    service:
      type: ClusterIP
      ports:
        http: 8080



    #ingress:
    #  enabled: true
    #  ingressClassName: "traefik"
    #  hostname: "${SECRET_DEV_DOMAIN}"
    #  path: /
    #  annotations:
    #    cert-manager.io/cluster-issuer: "letsencrypt-production"
    #    traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
    #    traefik.ingress.kubernetes.io/protocol: "http"
    #    external-dns.home.arpa/enabled: "true"
    #  hosts:
    #    - host: &uri "${SECRET_DEV_DOMAIN}"
    #      paths:
    #        - /
    #  tls:
    #    - hosts:
    #        - *uri
    #      secretName: *uri

